# DNSはどのように機能するか?

DNSとはドメイン名を使用して、インターネット上の各デバイスに割り当てられたIPアドレスに変換するために使用される。
ユーザがクライアントに入力した内容とインターネット上の住所であるIPアドレスを変換する必要がある。

## 4つのDNSサーバ

### DNS再帰リゾルバ

Webブラウザなどのクライアントからクエリを直接受信するDNSサーバ。
キャッシュされたデータもしくは、ルートDNSサーバに要求を送信する。
ルートネームサーバから受信した、データを元にTLDネームサーバ, 権威ネームサーバというふうにリクエストを行い名前解決を行う。
権威ネームサーバかデータを受信したらクライアントにレスポンスを送信する。

一連のプロセスを行う途中でDNS再帰リゾルバは権威ネームサーバから受信した情報をキャッシュし、別のクライアントから同じドメインに対してリクエストがあった場合にキャッシュから情報を取得しレスポンスを返す。

### ルートネームサーバ

ルートネームサーバは、DNS再帰リゾルバからリクエストを受けて該当するTLDネームサーバにリクエストを行うよう、DNS再帰リゾルバにレスポンスを返す。

ルートDNSはICANNと呼ばれる非営利団体によって管理されている。

### TLDネームサーバ

TLDネームサーバは、TLDの後(左側)に続くドメイン名の情報を保持している。
たとえば`.com`のTLDネームサーバには`.com`で終わる全てのWebサイトの情報が含まれている。
TLDネームサーバは、該当する権威ネームサーバにクエリを送信するように、DNS再帰リゾルバへレスポンスを送信する。

TLDネームサーバはICANNの支部であるIANAによって管理されている。

### 権威ネームサーバ

DNSを実査に保持しDNSに対して責任を負うネームサーバ。

TLDネームサーバからレスポンスを受け取ったDNS再帰リゾルバが権威ネームサーバににリクエストを送信する。
権威ネームサーバには、ドメイン名の固有の情報が含まれており、DNSAレコードで見つかったサーバのIPアドレスをDNS再帰リゾルバにレスポンスとして送信する。
CNAMEレコード(エイリアスレコード)がある場合は、CNAMEレコードを送信する。

## DNSルックアップの手順

1. クライアントからドメインが送信されDNS再帰リゾルバに受信される
2. DNS再帰リゾルバが、ルートネームサーバに照会を行う
3. ルートネームサーバは照会内容に基づいてTLDネームサーバのアドレスを再帰リゾルバにレスポンスを返す
4. 再帰リゾルバは、受け取ったレスポンスを元にTLDネームサーバにリクエストを送信する
5. TLDネームサーバは、権威ネームサーバのアドレスを再帰リゾルバにレスポンスとして送信する
6. TLDネームサーバから受け取ったレスポンスを元に、権威DNSにクエリを送信する
7. 権威DNSサーバはIPアドレスを再帰リゾルバに送信する
8. 再帰リゾルバは受け取った IPアドレスをクライアントにレスポンスとして送信する

## DNSキャッシュ

DNSをキャッシュすることによってクライアントの近くでデータを保存するためDNSによる名前解決を素早く行うことができる。
DNSルックアップに伴うクエリの実行や帯域幅CPUリソースの消費量の削減を行うことができる。
キャッシュされたDNSは、TTLによって一定期間レコードが保存されてる。

### ブラウザDNSキャッシュ

最新のWebブラウザは、デフォルトでDNSレコードを一定期間キャッシュするように設計されている。
そのため、DNSレコードのリクエストが行われると最初に、ブラウザのDNSキャッシュにレコードがあるかチェックされる。

### OSレベルのDNSキャッシュ

OSレベルのDNSクエリの処理のことを「スタブリゾルバ」もしくは、「DNS」クライアントと呼ばれる。
OSレベルのDNSリゾルバはDNSクエリがマシンから送信される前ににチェックされる。
レコードがない場合インターネットサービスの再帰リゾルバにDNSクエリを送信する。
